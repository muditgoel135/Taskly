<!doctype html>
<html>

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>{{ page.title }} — Taskly Editor</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous">

    <!-- Quill CSS -->
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/quill-mathquill@1.0.3/dist/quill-mathquill.min.js"></script>

    <!-- MathQuill Integration -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mathquill@0.10.1/build/mathquill.css" />
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mathquill@0.10.1/build/mathquill.min.js"></script>
    <script>
        var MQ = MathQuill.getInterface(2);
    </script>

    <style>
        :root {
            --bg: #0f1720;
            --surface: #121826;
            --accent: #38bdf8;
            --muted: #94a3b8;
            --white: #e2e8f0;
        }

        body {
            margin: 0;
            font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
            background: var(--bg);
            color: var(--white);
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        header {
            background: var(--surface);
            padding: 12px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.4);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        header h1 {
            font-size: 18px;
            margin: 0;
            color: var(--white);
        }

        #status {
            font-size: 13px;
            color: var(--muted);
            margin-left: 8px;
        }

        #editor {
            flex: 1;
            background: #121826;
            color: #fff;
            margin: 20px;
            border-radius: 10px;
            padding: 16px;
            border-top: 1px solid #ccc !important;
            margin-top: 5px !important;
        }

        #saveBtn {
            background: var(--accent);
            border: none;
            border-radius: 8px;
            padding: 8px 14px;
            color: #022;
            font-weight: 600;
            cursor: pointer;
        }

        #saveBtn:hover {
            background: #7dd3fc;
        }

        .toolbar {
            border-bottom: 0px solid #ddd;
        }

        footer {
            padding: 8px 20px;
            font-size: 13px;
            color: var(--muted);
            text-align: right;
            background: var(--surface);
        }

        .ql-editor {
            min-height: 70vh;
        }

        a.link {
            color: var(--muted);
            text-decoration: none;
            margin-right: 12px;
        }

        @media (max-width: 600px) {
            header h1 {
                font-size: 16px;
            }

            #editor {
                margin: 10px;
                padding: 10px;
            }
        }

        /* Recolor Quill toolbar icons */
        .ql-snow .ql-stroke {
            stroke: var(--white) !important;
            /* or your color, e.g. #38bdf8 */
        }

        .ql-snow .ql-fill {
            fill: var(--white) !important;
        }

        .ql-snow .ql-picker {
            color: var(--white) !important;
        }

        .ql-toolbar.ql-snow {
            border-radius: 5px;
            margin: 20px;
        }
    </style>
</head>

<body>
    <header>
        <div>
            <a class="link" href="{{ url_for('pages.index') }}">← All pages</a>
            <h1 id="pageTitle" contenteditable="true" style="margin: 4px;">{{ page.title }}</h1>
            <span id="status"></span>
        </div>
        <button id="saveBtn">Save</button>
        <button class="link btn btn-danger"
            onclick="if(confirm('Are you sure you want to delete this page? This action cannot be undone.')) {fetch('{{ url_for('pages.delete_page', page_id=page.id) }}', { method: 'POST' }).then(() => {window.location.href='{{ url_for('pages.index') }}'; }); }">
            Delete Page
        </button>
    </header>

    <div id="editor"></div>

    <footer>
        <span>Taskly Page Editor — autosaves every 8 seconds</span>
    </footer>

    <!-- Quill JS -->
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>

    <script>
        const pageId = {{ page.id }};
        const initialHtml = {{ page.content| tojson | safe }};
        const initialDelta = {{ (page.content_delta or 'null')| tojson | safe }};

        const quill = new Quill('#editor', {
            theme: 'snow',
            modules: {
                toolbar: [
                    ['bold', 'italic', 'underline', 'strike'],
                    [{ 'header': [1, 2, 3, 4, 5, 6, false] }],
                    [{ 'size': ['small', false, 'large', 'huge'] }],
                    [{ 'font': [] }],
                    [{ 'script': 'sub' }, { 'script': 'super' }],
                    [{ 'direction': 'rtl' }],
                    [{ 'indent': '-1' }, { 'indent': '+1' }],
                    [{ 'align': ['', 'center', 'right', 'justify'] }],
                    [{ 'list': 'ordered' }, { 'list': 'bullet' }, { 'list': 'check' }],
                    ['blockquote', 'code-block'],
                    [{ 'color': [] }, { 'background': [] }],
                    ['link', 'image', 'video', 'formula'],
                    ['clean']
                ]
            }
        });

        // Load existing content (prefer delta if present)
        if (initialDelta) {
            try {
                quill.setContents(JSON.parse(initialDelta));
            } catch (err) {
                quill.root.innerHTML = initialHtml;
            }
        } else {
            quill.root.innerHTML = initialHtml;
        }

        const statusEl = document.getElementById('status');
        let lastSaved = quill.getContents();
        let saving = false;

        async function save() {
            if (saving) return;
            saving = true;
            statusEl.textContent = "Saving…";
            const html = quill.root.innerHTML;
            const delta = quill.getContents();

            try {
                const res = await fetch(`/api/save/${pageId}`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        title: document.getElementById('pageTitle').textContent.trim(),
                        content_html: html,
                        delta: delta
                    })
                });
                console.log(document.getElementById('pageTitle').textContent.trim());
                const data = await res.json();
                if (data.success) {
                    lastSaved = quill.getContents();
                    statusEl.textContent = "Saved " + new Date().toLocaleTimeString();
                } else {
                    statusEl.textContent = "Save failed";
                }
            } catch (err) {
                console.error(err);
                statusEl.textContent = "Network error";
            } finally {
                saving = false;
            }
        }

        document.getElementById("saveBtn").addEventListener("click", save);

        // Autosave every 8 seconds if content changed
        setInterval(() => {
            const cur = quill.getContents();
            if (JSON.stringify(cur) !== JSON.stringify(lastSaved)) save();
        }, 8000);

        // Warn if navigating away with unsaved changes
        window.addEventListener("beforeunload", (e) => {
            const cur = quill.getContents();
            if (JSON.stringify(cur) !== JSON.stringify(lastSaved)) {
                e.preventDefault();
                e.returnValue = "";
            }
        });
    </script>
</body>

</html>